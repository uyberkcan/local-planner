<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Dynamic Status Bar Colors for Mobile -->
    <meta name="theme-color" content="#FDFBF7" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">

    <title>UyanPlanner</title>
    
    <!-- PWA Manifest (Data URI) -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIlV5YW5QbGFubmVyIiwKICAic2hvcnRfbmFtZSI6ICJVeWFuIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNGREZCRjciLAogICJ0aGVtZV9jb2xvciI6ICIjRDRBRjM3IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vMTkyeDE5Mi84MDAwMjAvRDRBRjM3P3RleHQ9VVAiLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vNTEyeDUxMi84MDAwMjAvRDRBRjM3P3RleHQ9VVAiLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Icons (Phosphor) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gold: {
                            400: '#E5C558',
                            500: '#D4AF37', // Classic Gold
                            600: '#B59026',
                        },
                        maroon: {
                            500: '#800020', // Burgundy
                            600: '#600018',
                            900: '#2C000A',
                        },
                        cream: '#FDFBF7',
                        onyx: '#121212',
                        charcoal: '#1E1E1E'
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Montserrat"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Styles & Reset */
        :root {
            --scrollbar-bg: transparent;
            --scrollbar-thumb: #D4AF37;
        }

        body {
            -webkit-tap-highlight-color: transparent;
            font-feature-settings: "lnum" 1;
            /* Prevents rubber-banding/pull-to-refresh on Android for native feel */
            overscroll-behavior-y: none; 
        }

        /* Luxury Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        ::-webkit-scrollbar-track {
            background: var(--scrollbar-bg);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        /* New: Slide animation for calendar months */
        @keyframes slideFade {
            0% { opacity: 0; transform: translateX(10px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        .animate-slide-in {
            animation: slideFade 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        .dark .loading-shimmer {
            background: linear-gradient(90deg, #1E1E1E 25%, #2A2A2A 50%, #1E1E1E 75%);
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .dark .glass-panel {
            background: rgba(30, 30, 30, 0.85);
        }

        /* Checkbox styling */
        .custom-checkbox input:checked + div {
            background-color: #D4AF37;
            border-color: #D4AF37;
        }
        
        /* Safe Area for modern mobile devices */
        .safe-pb {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<!-- UPDATED BODY: Used h-[100dvh] for reliable mobile viewport height -->
<body class="bg-gradient-to-br from-[#FDFBF7] via-[#F4EBD0] to-[#E0C998] text-charcoal dark:from-[#0F0F0F] dark:via-[#1F1216] dark:to-[#3D0E18] dark:text-gray-200 transition-colors duration-500 font-sans antialiased h-[100dvh] flex flex-col overflow-hidden bg-fixed">

    <!-- Header -->
    <header class="flex-none px-6 py-5 flex justify-between items-center z-20 glass-panel border-b border-gold-500/20">
        <!-- Logo Container -->
        <div class="inline-flex flex-col cursor-pointer group" onclick="app.router.navigate('dashboard')">
            <h1 class="font-serif text-2xl font-bold text-maroon-600 dark:text-gold-500 leading-none tracking-widest">UYAN</h1>
            <div class="flex justify-between w-full text-[0.65rem] text-gray-500 dark:text-gray-400 font-sans font-bold mt-1 uppercase">
                <span>P</span><span>l</span><span>a</span><span>n</span><span>n</span><span>e</span><span>r</span>
            </div>
        </div>

        <div class="flex gap-4 items-center">
            <button onclick="app.toggleTheme()" class="text-gray-500 hover:text-gold-500 transition-colors">
                <i class="ph ph-moon text-xl dark:hidden"></i>
                <i class="ph ph-sun text-xl hidden dark:block"></i>
            </button>
            <button onclick="app.ui.openSettings()" class="text-gray-500 hover:text-gold-500 transition-colors">
                <i class="ph ph-gear text-xl"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-container" class="flex-1 relative overflow-hidden">
        <!-- Views will be injected here -->
    </main>

    <!-- Modals Container -->
    <div id="modal-layer" class="fixed inset-0 z-50 pointer-events-none flex items-center justify-center"></div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-maroon-500 text-white px-6 py-3 rounded-full shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none z-50 text-sm font-medium">
        Notification
    </div>

    <script>
        // --- Utilities ---
        const Utils = {
            uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            formatDate: (str) => new Date(str).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
            getDaysArray: (start, end) => {
                const arr = [];
                for(let dt = new Date(start); dt <= new Date(end); dt.setDate(dt.getDate()+1)){
                    arr.push(new Date(dt).toISOString().split('T')[0]);
                }
                return arr;
            },
            getDateRangeDisplay: (startDate, endDate) => {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
                return `${Utils.formatDate(startDate)} — ${Utils.formatDate(endDate)} (${days} days)`;
            },
            getCountdown: (startDate) => {
                const start = new Date(startDate);
                const today = new Date();
                start.setHours(0,0,0,0);
                today.setHours(0,0,0,0);
                const diffTime = start - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                if (diffDays < 0) return "Past Event";
                if (diffDays === 0) return "Happening Now";
                if (diffDays === 1) return "Starts Tomorrow";
                return `${diffDays} days to go`;
            }
        };

        // --- Store ---
        const Store = {
            key: 'uyan_data_v1',
            apiKeyKey: 'uyan_gemini_key',
            
            get: () => JSON.parse(localStorage.getItem(Store.key) || '{"events": [], "theme": "light"}'),
            save: (data) => localStorage.setItem(Store.key, JSON.stringify(data)),
            getApiKey: () => localStorage.getItem(Store.apiKeyKey),
            setApiKey: (key) => localStorage.setItem(Store.apiKeyKey, key),

            addEvent: (event) => {
                const data = Store.get();
                data.events.push(event);
                Store.save(data);
                return data;
            },
            updateEvent: (updatedEvent) => {
                const data = Store.get();
                const idx = data.events.findIndex(e => e.id === updatedEvent.id);
                if (idx !== -1) {
                    data.events[idx] = updatedEvent;
                    Store.save(data);
                }
            },
            deleteEvent: (id) => {
                const data = Store.get();
                data.events = data.events.filter(e => e.id !== id);
                Store.save(data);
            }
        };

        // --- AI (Gemini) ---
        const AI = {
            fetchWithRetry: async (url, options, maxRetries = 3) => {
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.ok) return response;
                        if (response.status === 429 || response.status >= 500) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000 + Math.random() * 1000));
                            continue;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                    } catch (error) {
                        if (i === maxRetries - 1) throw error;
                    }
                }
            },

            // UPDATED: Robust call method with Strict Model Fallback & Future-Proofing
            call: async (prompt, responseSchema = null) => {
                const apiKey = Store.getApiKey();
                if (!apiKey) throw new Error("API Key missing");

                // Priority: 
                // 1. Future/Source models (2.5/3) - if they exist for you
                // 2. Latest Stable (1.5-flash/pro) - high chance of success
                // 3. Specific Versions (001/002) - fallbacks for strict stability
                const models = [
                    // The "Future" models from your source
                    { name: 'gemini-2.5-flash', version: 'v1beta' },
                    { name: 'gemini-3-pro-preview', version: 'v1beta' },
                    
                    // The Current Gold Standards (Highly likely to work)
                    { name: 'gemini-1.5-flash', version: 'v1beta' },
                    { name: 'gemini-1.5-pro', version: 'v1beta' },
                    
                    // Specific Stable Versions (Fallbacks)
                    { name: 'gemini-1.5-flash-001', version: 'v1beta' },
                    { name: 'gemini-1.5-flash-002', version: 'v1beta' },
                    { name: 'gemini-1.5-flash-8b', version: 'v1beta' }, // Fast variant
                    
                    // Legacy Fallbacks
                    { name: 'gemini-1.0-pro', version: 'v1beta' },
                    { name: 'gemini-pro', version: 'v1' } 
                ];
                
                let lastError = null;

                for (const modelConfig of models) {
                    try {
                        console.log(`Attempting ${modelConfig.name} on ${modelConfig.version}`);
                        const url = `https://generativelanguage.googleapis.com/${modelConfig.version}/models/${modelConfig.name}:generateContent?key=${apiKey}`;
                        
                        const payload = { contents: [{ parts: [{ text: prompt }] }] };
                        
                        // Only Attach Schema for models that definitely support it (1.5+)
                        // We skip schema for 1.0/Pro legacy to prevent errors, relying on prompt engineering
                        if (responseSchema && (modelConfig.name.includes('1.5') || modelConfig.name.includes('2.5') || modelConfig.name.includes('3'))) {
                            payload.generationConfig = {
                                responseMimeType: "application/json",
                                responseSchema: responseSchema
                            };
                        }

                        const response = await AI.fetchWithRetry(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const data = await response.json();
                        if(data.error) throw new Error(data.error.message);
                        
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!text) throw new Error("Empty AI response");

                        // Clean markdown fences regardless of model/schema usage
                        const cleanText = text.replace(/```json|```/g, '').trim();
                        
                        return JSON.parse(cleanText);

                    } catch (e) {
                        console.warn(`${modelConfig.name} failed:`, e.message);
                        lastError = e;
                        // Stop if it's an Auth error (Invalid Key), otherwise continue loop
                        if (e.message.includes('API key') || e.message.includes('403')) break;
                    }
                }
                
                throw lastError || new Error("All AI models failed. Please check API Key permissions.");
            },

            generateItinerary: async (name, days, theme, tone) => {
                const schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            date: { type: "STRING" },
                            highlights: { type: "ARRAY", items: { type: "STRING" } },
                        },
                        required: ["date", "highlights"]
                    }
                };

                const personaMap = {
                    'Luxury Holiday': 'high-end luxury concierge',
                    'Family Event': 'family activity coordinator',
                    'Weekend Trip': 'efficient travel organizer',
                    'Nature Retreat': 'outdoor adventure guide',
                    'Culture & History': 'cultural historian',
                    'Relaxed Getaway': 'wellness coach'
                };
                const persona = personaMap[theme] || 'experienced event planner';

                const prompt = `Act as a ${persona}. Generate a simple itinerary for "${name}". Duration: ${days} days. Theme: ${theme}. Tone: ${tone}. 3 highlights/day. Return strictly a JSON array matching dates (YYYY-MM-DD).`;
                return await AI.call(prompt, schema);
            },

            generateChecklist: async (context) => {
                const schema = {
                    type: "ARRAY",
                    items: { type: "STRING" }
                };
                const prompt = `Create a checklist of 5 practical preparation items for: ${context}. Keep items short. Return strictly a JSON array of strings.`;
                return await AI.call(prompt, schema);
            }
        };

        // --- App Logic ---
        class App {
            constructor() {
                this.container = document.getElementById('app-container');
                this.modalLayer = document.getElementById('modal-layer');
                this.state = {
                    currentView: 'dashboard',
                    activeEventId: null,
                    activeDay: null,
                    calendarSelection: { start: null, end: null },
                    calendarViewDate: new Date(), // Init here
                    tempAiItinerary: null,
                    touchStartX: 0, // For Swipe
                    lastScroll: 0   // For Wheel Debounce
                };
                this.init();
            }

            init() {
                const data = Store.get();
                if (data.theme === 'dark') document.documentElement.classList.add('dark');
                
                // Magic Link Init
                const urlParams = new URLSearchParams(window.location.search);
                const magicKey = urlParams.get('key');
                if (magicKey) {
                    Store.setApiKey(magicKey);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    setTimeout(() => app.showToast("AI Features Activated!"), 1000);
                }

                this.router = {
                    navigate: (view, params = {}) => {
                        this.state.currentView = view;
                        if(params.eventId) this.state.activeEventId = params.eventId;
                        this.render();
                    }
                };
                this.render();
            }

            toggleTheme() {
                document.documentElement.classList.toggle('dark');
                const data = Store.get();
                data.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                Store.save(data);
            }

            showToast(msg) {
                const el = document.getElementById('toast');
                el.innerText = msg;
                el.style.opacity = '1';
                setTimeout(() => el.style.opacity = '0', 3000);
            }

            render() {
                this.container.innerHTML = '';
                if (this.state.currentView === 'dashboard') this.renderDashboard();
                else if (this.state.currentView === 'itinerary') this.renderItinerary();
            }

            renderDashboard() {
                const data = Store.get();
                const hasEvents = data.events.length > 0;

                const html = `
                    <div class="h-full overflow-y-auto p-6 animate-fade-in min-h-0 pb-24 safe-pb">
                        <div class="max-w-4xl mx-auto">
                            <!-- UPDATED: Refined Dashboard Header -->
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
                                <div>
                                    <h2 class="font-serif text-3xl text-maroon-500 dark:text-white mb-1">My Events</h2>
                                    <p class="text-xs uppercase tracking-widest text-gold-600 dark:text-gold-500 font-semibold">Your Plans</p>
                                </div>
                                <div class="flex items-center gap-3 w-full md:w-auto">
                                     <button onclick="document.getElementById('import-input').click()" class="flex-1 md:flex-none text-center bg-white dark:bg-charcoal border border-gray-200 dark:border-gray-700 hover:border-gold-500 text-gray-600 dark:text-gray-300 px-4 py-2 rounded-lg text-sm transition-all shadow-sm font-medium">
                                        Import
                                    </button>
                                    <input type="file" id="import-input" class="hidden" accept=".json" onchange="app.handlers.importEvent(this)">
                                    
                                    <button onclick="app.ui.openCreateModal()" class="flex-1 md:flex-none justify-center bg-gold-500 hover:bg-gold-600 text-white px-5 py-2 rounded-lg text-sm font-medium transition-all shadow-lg shadow-gold-500/30 flex items-center gap-2">
                                        <i class="ph ph-plus text-lg"></i> <span>New Event</span>
                                    </button>
                                </div>
                            </div>

                            ${!hasEvents ? `
                                <div class="text-center py-20 opacity-50">
                                    <i class="ph ph-calendar-blank text-6xl text-gray-300 dark:text-gray-700 mb-4"></i>
                                    <p class="text-lg font-serif text-gray-400">No events planned yet.</p>
                                </div>
                            ` : `
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${data.events.map(event => `
                                        <div onclick="app.router.navigate('itinerary', {eventId: '${event.id}'})" class="group bg-white dark:bg-charcoal p-6 rounded-xl shadow-md hover:shadow-xl hover:shadow-gold-500/10 transition-all cursor-pointer border-t-4 border-transparent hover:border-gold-500 relative overflow-hidden flex flex-col h-40">
                                            <div class="absolute top-0 right-0 p-4 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <i class="ph ph-arrow-right text-gold-500"></i>
                                            </div>
                                            <div class="absolute bottom-4 right-4 z-10" onclick="event.stopPropagation()">
                                                <button onclick="app.ui.openDeleteConfirm('${event.id}')" class="p-2 text-gray-300 hover:text-red-500 transition-colors"><i class="ph ph-trash text-lg"></i></button>
                                            </div>
                                            <div class="mb-auto">
                                                <h3 class="font-serif text-lg text-maroon-500 dark:text-white mb-1 truncate pr-6">${event.name}</h3>
                                                <p class="text-xs tracking-widest uppercase text-gray-400 font-semibold">
                                                    ${Utils.formatDate(event.startDate)} — ${Utils.formatDate(event.endDate)}
                                                </p>
                                            </div>
                                            <div class="flex items-center gap-4 text-xs text-gray-500 dark:text-gray-400 mt-4">
                                                <div class="flex items-center gap-1"><i class="ph ph-clock"></i><span>${Object.keys(event.days).length} Days</span></div>
                                                <div class="flex items-center gap-1 text-gold-600 dark:text-gold-400 font-medium"><i class="ph ph-hourglass"></i><span>${Utils.getCountdown(event.startDate)}</span></div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
                this.container.innerHTML = html;
            }

            renderItinerary() {
                const data = Store.get();
                const event = data.events.find(e => e.id === this.state.activeEventId);
                if (!event) return this.router.navigate('dashboard');
                const sortedDates = Object.keys(event.days).sort();

                const html = `
                    <div class="h-full flex flex-col animate-fade-in">
                        <div class="px-6 py-4 bg-white/50 dark:bg-onyx/50 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center backdrop-blur-md sticky top-0 z-10">
                            <button onclick="app.router.navigate('dashboard')" class="text-sm font-semibold text-gray-500 hover:text-maroon-500 flex items-center gap-1">
                                <i class="ph ph-caret-left"></i> Back to Hub
                            </button>
                            <div class="flex gap-2">
                                <button onclick="app.handlers.downloadICS()" class="p-2 text-gray-500 hover:text-gold-500" title="Export"><i class="ph ph-calendar-plus text-lg"></i></button>
                                <button onclick="app.handlers.shareEvent()" class="p-2 text-gray-500 hover:text-gold-500" title="Share"><i class="ph ph-share-network text-lg"></i></button>
                                <button onclick="app.ui.openDeleteConfirm('${event.id}')" class="p-2 text-gray-400 hover:text-red-500" title="Delete"><i class="ph ph-trash text-lg"></i></button>
                            </div>
                        </div>

                        <!-- Header -->
                        <div class="px-6 py-8 md:px-12 bg-transparent">
                            <div class="max-w-5xl mx-auto flex flex-row justify-between items-start gap-4">
                                <div class="flex-1 min-w-0">
                                    <h1 class="font-serif text-2xl md:text-3xl text-maroon-500 dark:text-white mb-1 truncate leading-tight">${event.name}</h1>
                                    <p class="text-gold-600 dark:text-gold-500 font-sans font-medium tracking-wide text-xs md:text-sm">
                                        ${Utils.getDateRangeDisplay(event.startDate, event.endDate)}
                                    </p>
                                </div>
                                <button onclick="app.ui.openPlanContextModal()" class="flex-none bg-gradient-to-r from-gray-900 to-gray-700 dark:from-gold-500 dark:to-gold-600 text-white px-3 py-1.5 rounded-lg shadow-lg flex items-center gap-1.5 hover:scale-105 transition-transform">
                                    <i class="ph ph-sparkle-fill text-gold-400 dark:text-white text-sm"></i>
                                    <span class="text-xs font-medium">Magic Auto-Plan</span>
                                </button>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto p-6 min-h-0 pb-24 safe-pb">
                            <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${sortedDates.map((dateStr, index) => {
                                    const dayData = event.days[dateStr];
                                    const highlightCount = dayData.highlights.length;
                                    const totalTasks = Object.values(dayData.checklists).flat().length;
                                    const doneTasks = Object.values(dayData.checklists).flat().filter(t => t.done).length;
                                    const progress = totalTasks === 0 ? 0 : (doneTasks / totalTasks) * 100;

                                    return `
                                        <div onclick="app.ui.openDayModal('${dateStr}')" class="bg-white dark:bg-charcoal p-5 rounded-lg border border-gray-100 dark:border-gray-800 hover:border-gold-500 cursor-pointer transition-all group h-full flex flex-col">
                                            <div class="flex justify-between items-start mb-3">
                                                <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Day ${index + 1}</span>
                                                <span class="text-xs text-gold-500 font-serif italic">${Utils.formatDate(dateStr)}</span>
                                            </div>
                                            <div class="flex-1 mb-4">
                                                ${highlightCount === 0 ? '<p class="text-gray-300 dark:text-gray-600 text-sm italic">No plans yet.</p>' : 
                                                    `<ul class="space-y-1">${dayData.highlights.slice(0, 3).map(h => `<li class="flex items-start gap-2 text-sm text-gray-700 dark:text-gray-300"><span class="text-gold-500 mt-1">•</span> <span class="truncate">${h}</span></li>`).join('')}${highlightCount > 3 ? `<li class="text-xs text-gray-400 pl-3">+${highlightCount - 3} more</li>` : ''}</ul>`
                                                }
                                            </div>
                                            <div class="mt-auto">
                                                <div class="flex justify-between text-[10px] text-gray-400 mb-1 uppercase tracking-wider font-semibold"><span>Tasks</span><span>${Math.round(progress)}%</span></div>
                                                <div class="h-1 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden"><div class="h-full bg-gold-500 transition-all duration-500" style="width: ${progress}%"></div></div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                this.container.innerHTML = html;
            }

            ui = {
                closeModal: () => {
                    this.modalLayer.innerHTML = '';
                    this.modalLayer.classList.add('pointer-events-none');
                },
                renderModal: (content, customClasses = 'max-w-md w-full') => {
                    // UPDATED: Added id="modal-content-panel" to target specifically for updates
                    this.modalLayer.innerHTML = `
                        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity opacity-0 animate-[fadeIn_0.2s_forwards]" onclick="app.ui.closeModal()"></div>
                        <div id="modal-content-panel" class="bg-white dark:bg-[#1E1E1E] rounded-2xl shadow-2xl p-4 md:p-6 relative z-10 opacity-0 animate-[fadeIn_0.3s_0.1s_forwards] ${customClasses}">${content}</div>
                    `;
                    this.modalLayer.classList.remove('pointer-events-none');
                },
                openConfirm: (title, msg, onConfirm, onCancel) => {
                    const confirmId = 'c-btn-' + Date.now();
                    const cancelId = 'ca-btn-' + Date.now();
                    app.ui.renderModal(`
                        <h3 class="font-serif text-lg mb-4 text-maroon-500 dark:text-white">${title}</h3>
                        <p class="text-sm text-gray-500 mb-6 break-words">${msg}</p>
                        <div class="flex gap-3">
                            <button id="${cancelId}" class="flex-1 py-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">Cancel</button>
                            <button id="${confirmId}" class="flex-1 bg-maroon-500 hover:bg-maroon-600 text-white rounded py-2 transition-colors">Confirm</button>
                        </div>
                    `);
                    document.getElementById(confirmId).onclick = () => { app.ui.closeModal(); if(onConfirm) onConfirm(); };
                    document.getElementById(cancelId).onclick = () => { app.ui.closeModal(); if(onCancel) onCancel(); };
                },
                openDeleteConfirm: (id) => app.ui.openConfirm('Delete Event?', 'This action cannot be undone.', () => { Store.deleteEvent(id); app.router.navigate('dashboard'); }),
                
                openSettings: () => {
                    app.ui.renderModal(`
                        <h3 class="font-serif text-lg mb-4 text-maroon-500 dark:text-white">Settings</h3>
                        <label class="block text-xs uppercase tracking-wide text-gray-500 mb-2">Gemini API Key</label>
                        <input type="password" id="api-key-input" value="${Store.getApiKey() || ''}" class="w-full bg-gray-50 dark:bg-black/20 border border-gray-200 dark:border-gray-700 rounded p-3 text-sm focus:border-gold-500 outline-none mb-4" placeholder="Enter key">
                        <button onclick="app.handlers.saveSettings()" class="w-full bg-maroon-500 text-white py-3 rounded hover:bg-maroon-600 transition-colors">Save Securely</button>
                    `);
                },

                openCreateModal: () => {
                    const today = new Date();
                    app.state.calendarSelection = { start: null, end: null };
                    app.state.calendarViewDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    app.ui.renderModal(`
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-serif text-lg text-maroon-500 dark:text-white">New Event</h3>
                            <div class="flex items-center gap-3">
                                <button onclick="app.handlers.resetCalendar()" class="text-gray-400 hover:text-red-500 transition-colors" title="Reset Dates">
                                    <i class="ph ph-arrow-counter-clockwise text-lg"></i>
                                </button>
                                <div class="flex items-center gap-1 bg-gray-100 dark:bg-white/5 rounded-lg p-1">
                                    <button onclick="app.handlers.prevMonth()" class="p-1 hover:text-gold-500"><i class="ph ph-caret-left"></i></button>
                                    <span id="cal-month-label" class="text-xs font-medium w-20 text-center"></span>
                                    <button onclick="app.handlers.nextMonth()" class="p-1 hover:text-gold-500"><i class="ph ph-caret-right"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-6">
                            <input type="text" id="event-name" class="w-full bg-transparent border-b border-gray-200 dark:border-gray-700 py-2 text-lg focus:border-gold-500 outline-none font-serif" placeholder="e.g. Kyoto Trip" enterkeyhint="done" onkeyup="if(event.key==='Enter')this.blur()">
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 mb-6 text-center text-sm h-[17rem] content-start overflow-hidden" onwheel="app.handlers.scrollMonth(event)" ontouchstart="app.handlers.touchStart(event)" ontouchend="app.handlers.touchEnd(event)"></div>
                        <button onclick="app.handlers.createEvent()" class="w-full bg-gold-500 text-white py-3 rounded hover:bg-gold-600 transition-colors font-medium">Create Event</button>
                    `);
                    app.ui.renderCalendarGrid();
                },

                renderCalendarGrid: () => {
                    const grid = document.getElementById('calendar-grid');
                    if (!grid) return;
                    
                    // NEW: Slide Animation triggers reflow for visual clue
                    grid.classList.remove('animate-slide-in');
                    void grid.offsetWidth; // Trigger reflow
                    grid.classList.add('animate-slide-in');

                    const d = app.state.calendarViewDate;
                    document.getElementById('cal-month-label').innerText = d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    
                    const firstDay = new Date(d.getFullYear(), d.getMonth(), 1).getDay();
                    const daysInMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
                    const { start, end } = app.state.calendarSelection;

                    let html = ['S','M','T','W','T','F','S'].map(d => `<span class="text-[10px] text-gray-400 mb-2">${d}</span>`).join('');
                    for (let i=0; i<firstDay; i++) html += `<span></span>`;
                    for (let day=1; day<=daysInMonth; day++) {
                        const dateStr = new Date(d.getFullYear(), d.getMonth(), day).toISOString().split('T')[0];
                        let classes = "h-8 w-8 mx-auto flex items-center justify-center rounded-full text-sm cursor-pointer transition-all ";
                        if (start === dateStr || end === dateStr) classes += "bg-gold-500 text-white shadow-md transform scale-110";
                        else if (start && end && dateStr > start && dateStr < end) classes += "bg-gold-100 dark:bg-gold-900/30 text-gold-600 dark:text-gold-400";
                        else classes += "hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300";
                        html += `<div onclick="app.handlers.selectDate('${dateStr}')" class="${classes}">${day}</div>`;
                    }
                    grid.innerHTML = html;
                },

                openPlanContextModal: () => {
                    const event = Store.get().events.find(e => e.id === app.state.activeEventId);
                    const themes = ['Luxury Holiday', 'Family Event', 'Weekend Trip', 'Nature Retreat', 'Culture & History', 'Relaxed Getaway'];
                    const tones = ['Relaxed', 'Fast-Paced', 'Romantic', 'Adventurous', 'Educational'];
                    app.ui.renderModal(`
                        <h3 class="font-serif text-lg mb-4 text-maroon-500 dark:text-white">Plan ${event.name}</h3>
                        <div class="space-y-4">
                            <div><label class="block text-xs uppercase text-gray-500 mb-2">Focus</label><input type="text" id="ai-focus" value="${event.name}" class="w-full bg-gray-50 dark:bg-black/20 border border-gray-200 dark:border-gray-700 rounded p-3 text-sm focus:border-gold-500 outline-none"></div>
                            <div><label class="block text-xs uppercase text-gray-500 mb-2">Theme</label><select id="ai-theme" class="w-full bg-gray-50 dark:bg-black/20 border border-gray-200 dark:border-gray-700 rounded p-3 text-sm focus:border-gold-500 outline-none">${themes.map(t=>`<option>${t}</option>`)}</select></div>
                            <div><label class="block text-xs uppercase text-gray-500 mb-2">Tone</label><select id="ai-tone" class="w-full bg-gray-50 dark:bg-black/20 border border-gray-200 dark:border-gray-700 rounded p-3 text-sm focus:border-gold-500 outline-none">${tones.map(t=>`<option>${t}</option>`)}</select></div>
                        </div>
                        <button onclick="app.handlers.startAutoPlan()" class="w-full mt-8 bg-gold-500 text-white py-3 rounded flex items-center justify-center gap-2"><i class="ph ph-sparkle-fill"></i> Generate</button>
                    `, 'max-w-md w-full');
                },

                openFullItineraryPreviewModal: (itinerary) => {
                    const event = Store.get().events.find(e => e.id === app.state.activeEventId);
                    app.state.tempAiItinerary = itinerary.filter(d => event.days[d.date]);
                    
                    const content = app.state.tempAiItinerary.map((d, i) => `
                        <div class="p-4 border-b border-gray-100 dark:border-gray-800">
                            <h4 class="font-serif text-lg text-maroon-500 dark:text-gold-400 mb-2">Day ${i+1}: ${Utils.formatDate(d.date)}</h4>
                            <label class="flex items-center text-xs font-bold text-gray-400 uppercase mb-2"><input type="checkbox" class="accent-gold-500 mr-2" id="day-select-${d.date}" checked> Select All</label>
                            <div class="pl-6 space-y-2">${d.highlights.map(h => {
                                const exists = event.days[d.date].highlights.includes(h);
                                return `<div class="text-sm flex items-start gap-2 ${exists?'text-gray-400 line-through':'text-gray-700 dark:text-gray-300'}"><i class="ph ph-circle-dashed mt-1 flex-none ${exists?'text-gray-400':'text-gold-500'}"></i><span class="break-words min-w-0 flex-1">${h}</span></div>`;
                            }).join('')}</div>
                        </div>
                    `).join('');

                    app.ui.renderModal(`
                        <div class="flex-none flex justify-between items-start mb-6 border-b border-gray-100 dark:border-gray-800 pb-4">
                            <h3 class="font-serif text-xl text-maroon-500 dark:text-white">Review Plan</h3>
                            <button onclick="app.ui.closeModal()" class="text-gray-400 hover:text-red-500"><i class="ph ph-x text-xl"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto mb-6 border border-gray-200 dark:border-gray-700 rounded-lg">${content}</div>
                        <div class="flex-none flex gap-3"><button onclick="app.ui.closeModal()" class="flex-1 py-3 text-gray-500">Cancel</button><button onclick="app.handlers.confirmFullItinerary()" class="flex-1 bg-gold-500 text-white py-3 rounded-lg shadow-md">Add Plans</button></div>
                    `, 'max-w-3xl h-[85vh] flex flex-col');
                },

                openDayModal: (dateStr) => {
                    const event = Store.get().events.find(e => e.id === app.state.activeEventId);
                    app.state.activeDay = dateStr;
                    app.state.activeTab = 'General';
                    app.ui.renderModal(app.ui.buildDayModalContent(event.days[dateStr], dateStr), 'w-[95%] max-w-2xl h-[85vh] flex flex-col');
                },

                buildDayModalContent: (dayData, dateStr) => {
                    const activeTab = app.state.activeTab || 'General';
                    const checklists = dayData.checklists[activeTab] || [];
                    
                    return `
                        <div class="flex-none flex justify-between items-start mb-6 border-b border-gray-100 dark:border-gray-800 pb-4">
                            <div><h3 class="font-serif text-xl text-maroon-500 dark:text-white">${Utils.formatDate(dateStr)}</h3><p class="text-xs uppercase tracking-wide text-gold-500 font-bold">Itinerary & Tasks</p></div>
                            <button onclick="app.ui.closeModal()" class="text-gray-400 hover:text-red-500"><i class="ph ph-x text-xl"></i></button>
                        </div>
                        <div class="flex-none mb-6">
                            <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-400 uppercase">Highlights</span><div id="highlight-action-container"><button onclick="app.handlers.showAddHighlightInput()" class="text-gold-500 text-xs hover:underline">+ Add</button></div></div>
                            <div id="add-highlight-form" class="hidden mb-4 animate-fade-in">
                                <div class="flex items-center gap-2"><input type="text" id="new-highlight-name" class="flex-1 bg-gray-50 dark:bg-black/20 border border-gray-200 dark:border-gray-700 rounded px-3 py-2 text-sm outline-none" placeholder="Activity name..." onkeypress="if(event.key==='Enter')app.handlers.submitHighlight()"><button onclick="app.handlers.submitHighlight()" class="bg-gold-500 text-white p-2 rounded"><i class="ph ph-check"></i></button><button onclick="app.handlers.hideAddHighlightInput()" class="text-gray-400 p-2"><i class="ph ph-x"></i></button></div>
                            </div>
                            <div class="flex flex-wrap gap-2">${dayData.highlights.length===0?'<span class="text-sm text-gray-400 italic">No highlights.</span>':dayData.highlights.map(h=>`<div class="bg-cream dark:bg-charcoal border border-gold-500/20 px-3 py-1.5 rounded-xl text-sm flex items-center gap-2 max-w-full"><span class="break-words min-w-0 flex-1">${h}</span><i onclick="app.handlers.removeHighlight('${h}')" class="ph ph-x text-xs cursor-pointer text-gray-400 hover:text-red-500 flex-none"></i></div>`).join('')}</div>
                        </div>
                        <div class="flex-none flex gap-4 overflow-x-auto border-b border-gray-200 dark:border-gray-700 mb-4 no-scrollbar">
                            <button onclick="app.handlers.switchTab('General')" class="pb-2 text-sm font-medium whitespace-nowrap border-b-2 ${activeTab==='General'?'border-maroon-500 text-maroon-500 dark:text-white dark:border-white':'border-transparent text-gray-400'}">General</button>
                            ${dayData.highlights.map(h=>`<button onclick="app.handlers.switchTab('${h}')" class="pb-2 text-sm font-medium whitespace-nowrap border-b-2 ${activeTab===h?'border-maroon-500 text-maroon-500 dark:text-white dark:border-white':'border-transparent text-gray-400'}">${h}</button>`).join('')}
                        </div>
                        <div class="flex-1 overflow-y-auto relative min-h-0">
                            <div class="flex justify-between items-center mb-3 sticky top-0 bg-white dark:bg-[#1E1E1E] z-10 py-2"><span class="text-xs font-bold text-gray-400 uppercase">Checklist: ${activeTab}</span><button onclick="app.handlers.autoList()" class="text-xs bg-gold-500/10 text-gold-600 dark:text-gold-400 px-2 py-1 rounded hover:bg-gold-500 hover:text-white transition-colors flex items-center gap-1"><i class="ph ph-magic-wand"></i> Auto-List</button></div>
                            <ul class="space-y-2">${checklists.map((t,i)=>`<li class="flex items-center gap-3 group"><label class="custom-checkbox flex items-center cursor-pointer"><input type="checkbox" class="hidden" ${t.done?'checked':''} onchange="app.handlers.toggleTask(${i})"><div class="w-5 h-5 border border-gray-300 dark:border-gray-600 rounded flex items-center justify-center">${t.done?'<i class="ph ph-check text-white text-xs"></i>':''}</div></label><span class="${t.done?'line-through text-gray-300 dark:text-gray-600':'text-gray-700 dark:text-gray-200'} text-sm flex-1 break-words min-w-0">${t.text}</span><button onclick="app.handlers.deleteTask(${i})" class="text-gray-300 hover:text-red-500 transition-colors"><i class="ph ph-trash"></i></button></li>`).join('')}</ul>
                            <div class="mt-4 flex gap-2"><input type="text" id="new-task-input" class="flex-1 bg-gray-50 dark:bg-black/20 border border-gray-200 dark:border-gray-700 rounded px-3 py-2 text-sm outline-none" placeholder="Add task..." onkeypress="if(event.key==='Enter')app.handlers.addTask()"><button onclick="app.handlers.addTask()" class="bg-gray-200 dark:bg-gray-700 px-4 rounded hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300"><i class="ph ph-plus"></i></button></div>
                        </div>
                    `;
                }
            };

            handlers = {
                saveSettings: () => {
                    const key = document.getElementById('api-key-input').value.trim();
                    if(key) { Store.setApiKey(key); app.showToast('Key Saved'); app.ui.closeModal(); }
                },
                prevMonth: () => { 
                    app.state.calendarViewDate.setMonth(app.state.calendarViewDate.getMonth()-1); 
                    app.ui.renderCalendarGrid(); 
                    document.activeElement?.blur(); // Dismiss keyboard
                },
                nextMonth: () => { 
                    app.state.calendarViewDate.setMonth(app.state.calendarViewDate.getMonth()+1); 
                    app.ui.renderCalendarGrid(); 
                    document.activeElement?.blur(); // Dismiss keyboard
                },
                
                // Reset Calendar Handler
                resetCalendar: () => {
                    app.state.calendarSelection = { start: null, end: null };
                    app.ui.renderCalendarGrid();
                    document.activeElement?.blur(); // Dismiss keyboard
                },

                // Swipe and Scroll Support for Calendar
                touchStart: (e) => app.state.touchStartX = e.changedTouches[0].screenX,
                touchEnd: (e) => {
                    const diff = e.changedTouches[0].screenX - app.state.touchStartX;
                    if(Math.abs(diff) > 50) diff > 0 ? app.handlers.prevMonth() : app.handlers.nextMonth();
                },
                scrollMonth: (e) => {
                    e.preventDefault();
                    if (Date.now() - app.state.lastScroll < 500) return;
                    app.state.lastScroll = Date.now();
                    e.deltaY > 0 ? app.handlers.nextMonth() : app.handlers.prevMonth();
                },

                selectDate: (d) => {
                    const s = app.state.calendarSelection;
                    if(!s.start || (s.start && s.end)) app.state.calendarSelection = { start: d, end: null };
                    else app.state.calendarSelection = d < s.start ? { start: d, end: s.start } : { start: s.start, end: d };
                    app.ui.renderCalendarGrid();
                    document.activeElement?.blur(); // Dismiss keyboard
                },

                createEvent: () => {
                    const name = document.getElementById('event-name').value;
                    const { start, end } = app.state.calendarSelection;
                    if (!name || !start || !end) return app.showToast('Fill all details');
                    const days = {};
                    Utils.getDaysArray(start, end).forEach(d => days[d] = { highlights: [], checklists: { 'General': [] } });
                    Store.addEvent({ id: Utils.uuid(), name, startDate: start, endDate: end, days });
                    app.ui.closeModal();
                    app.router.navigate('dashboard');
                },

                importEvent: (input) => {
                    if(!input.files[0]) return;
                    const r = new FileReader();
                    r.onload = (e) => {
                        try {
                            const evt = JSON.parse(e.target.result);
                            if(evt.name) { evt.id = Utils.uuid(); Store.addEvent(evt); app.router.navigate('dashboard'); app.showToast('Imported'); }
                        } catch(e){ app.showToast('Invalid File'); }
                    };
                    r.readAsText(input.files[0]);
                },

                switchTab: (t) => {
                    app.state.activeTab = t;
                    const evt = Store.get().events.find(e => e.id === app.state.activeEventId);
                    // UPDATED: Now targeting #modal-content-panel instead of the fragile selector to fix the nested duplicate bug
                    document.getElementById('modal-content-panel').innerHTML = app.ui.buildDayModalContent(evt.days[app.state.activeDay], app.state.activeDay);
                },

                showAddHighlightInput: () => {
                    document.getElementById('highlight-action-container').classList.add('hidden');
                    document.getElementById('add-highlight-form').classList.remove('hidden');
                    document.getElementById('new-highlight-name').focus();
                },
                hideAddHighlightInput: () => {
                    document.getElementById('highlight-action-container').classList.remove('hidden');
                    document.getElementById('add-highlight-form').classList.add('hidden');
                },
                submitHighlight: () => {
                    const val = document.getElementById('new-highlight-name').value.trim();
                    if(val) {
                        const evt = Store.get().events.find(e => e.id === app.state.activeEventId);
                        evt.days[app.state.activeDay].highlights.push(val);
                        if(!evt.days[app.state.activeDay].checklists[val]) evt.days[app.state.activeDay].checklists[val] = [];
                        Store.updateEvent(evt);
                        app.handlers.switchTab(app.state.activeTab);
                        app.render();
                    } else app.handlers.hideAddHighlightInput();
                },
                removeHighlight: (val) => {
                    app.ui.openConfirm('Remove Highlight?', `Remove "${val}" and all its tasks?`, () => {
                        const evt = Store.get().events.find(e => e.id === app.state.activeEventId);
                        const day = evt.days[app.state.activeDay];
                        day.highlights = day.highlights.filter(h => h !== val);
                        delete day.checklists[val];
                        if(app.state.activeTab === val) app.state.activeTab = 'General';
                        Store.updateEvent(evt);
                        app.ui.openDayModal(app.state.activeDay);
                        app.render();
                    }, () => app.ui.openDayModal(app.state.activeDay));
                },

                addTask: () => {
                    const txt = document.getElementById('new-task-input').value.trim();
                    if(!txt) return;
                    const evt = Store.get().events.find(e => e.id === app.state.activeEventId);
                    evt.days[app.state.activeDay].checklists[app.state.activeTab || 'General'].push({ text: txt, done: false });
                    Store.updateEvent(evt);
                    app.handlers.switchTab(app.state.activeTab);
                    app.render();
                },
                toggleTask: (idx) => {
                    const evt = Store.get().events.find(e => e.id === app.state.activeEventId);
                    const t = evt.days[app.state.activeDay].checklists[app.state.activeTab || 'General'][idx];
                    t.done = !t.done;
                    Store.updateEvent(evt);
                    app.handlers.switchTab(app.state.activeTab);
                    app.render();
                },
                deleteTask: (idx) => {
                    const evt = Store.get().events.find(e => e.id === app.state.activeEventId);
                    evt.days[app.state.activeDay].checklists[app.state.activeTab || 'General'].splice(idx, 1);
                    Store.updateEvent(evt);
                    app.handlers.switchTab(app.state.activeTab);
                    app.render();
                },

                // FIXED: Get input values BEFORE closing modal to prevent "cannot read properties of null"
                startAutoPlan: async () => {
                    if(!Store.getApiKey()) return app.ui.openSettings();
                    const focusEl = document.getElementById('ai-focus');
                    const themeEl = document.getElementById('ai-theme');
                    const toneEl = document.getElementById('ai-tone');
                    
                    const focus = focusEl ? focusEl.value : '';
                    const theme = themeEl ? themeEl.value : '';
                    const tone = toneEl ? toneEl.value : '';

                    if(!focus) return app.showToast('Enter focus');
                    const evt = Store.get().events.find(e => e.id === app.state.activeEventId);
                    app.ui.closeModal();
                    app.showToast('Consulting AI...');
                    try {
                        const plan = await AI.generateItinerary(focus, Object.keys(evt.days).length, theme, tone);
                        app.ui.openFullItineraryPreviewModal(plan);
                    } catch(e) { app.showToast(e.message); }
                },

                confirmFullItinerary: () => {
                    const evt = Store.get().events.find(e => e.id === app.state.activeEventId);
                    let count = 0;
                    app.state.tempAiItinerary.forEach(d => {
                        if(evt.days[d.date] && document.getElementById(`day-select-${d.date}`).checked) {
                            d.highlights.forEach(h => {
                                if(!evt.days[d.date].highlights.includes(h)) {
                                    evt.days[d.date].highlights.push(h);
                                    evt.days[d.date].checklists[h] = [];
                                    count++;
                                }
                            });
                        }
                    });
                    Store.updateEvent(evt);
                    app.render();
                    app.ui.closeModal();
                    app.showToast(`Added ${count} highlights`);
                },

                autoList: async () => {
                    if(!Store.getApiKey()) return app.ui.openSettings();
                    const btn = document.querySelector('.ph-magic-wand').parentElement;
                    const old = btn.innerHTML;
                    btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i>';
                    try {
                        const items = await AI.generateChecklist(app.state.activeTab === 'General' ? 'General Prep' : app.state.activeTab);
                        const evt = Store.get().events.find(e => e.id === app.state.activeEventId);
                        items.forEach(t => evt.days[app.state.activeDay].checklists[app.state.activeTab].push({text: t, done: false}));
                        Store.updateEvent(evt);
                        app.handlers.switchTab(app.state.activeTab);
                        app.render();
                    } catch(e) { 
                        console.error(e);
                        // FIXED: Show specific error message in toast
                        app.showToast(e.message || 'AI Error'); 
                    } 
                    finally { btn.innerHTML = old; }
                },

                downloadICS: () => {
                    const evt = Store.get().events.find(e => e.id === app.state.activeEventId);
                    let ics = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//UyanPlanner//EN\n`;
                    Object.keys(evt.days).forEach(d => {
                        evt.days[d].highlights.forEach(h => {
                            ics += `BEGIN:VEVENT\nUID:${Utils.uuid()}@uyanplanner.com\nDTSTART;VALUE=DATE:${d.replace(/-/g, '')}\nSUMMARY:${h}\nDESCRIPTION:${evt.name} - ${h}\nEND:VEVENT\n`;
                        });
                    });
                    ics += `END:VCALENDAR`;
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(new Blob([ics], {type: 'text/calendar'}));
                    a.download = `${evt.name}.ics`;
                    a.click();
                },
                shareEvent: async () => {
                    const evt = Store.get().events.find(e => e.id === app.state.activeEventId);
                    const f = new File([JSON.stringify(evt, null, 2)], `${evt.name}.json`, {type: "application/json"});
                    
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [f] })) {
                        try {
                            await navigator.share({
                                files: [f],
                                title: evt.name,
                                text: 'Here is our itinerary.'
                            });
                        } catch (error) {
                            if (error.name !== 'AbortError') {
                                console.warn('Share failed, falling back', error);
                                app.showToast('Share failed, downloading instead...');
                                const a = document.createElement('a'); 
                                a.href = URL.createObjectURL(f); 
                                a.download = f.name; 
                                a.click();
                            }
                        }
                    } else {
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(f);
                        a.download = f.name;
                        a.click();
                        app.showToast('Downloaded (Sharing not supported)');
                    }
                }
            };
        }
        const app = new App();
    </script>
</body>
</html>